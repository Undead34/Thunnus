---
const { title, target } = Astro.props;

// Get parameters to pass through to the iframe
const client_id = Astro.url.searchParams.get("client_id");
const targetUrl = target + (client_id ? `?client_id=${client_id}` : "");
---

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        iframe { border: none; width: 100%; height: 100vh; display: block; }
    </style>
</head>
<body>
    <iframe id="phishing-iframe" src={targetUrl} title={title}></iframe>
    
    <script>
        import { Temporal } from "temporal-polyfill";

        // Types and Interfaces
        interface ClientSessionData {
            id: string;
            startedAt: Temporal.Instant;
            endedAt: Temporal.Instant;
            duration: number;
            eventsCount: number;
            events: any[];
        }

        const client_id = new URLSearchParams(document.location.search).get("client_id");

        // Session Service: Handles event logging and duration
        const sessionService = (() => {
            function generateUniqueId() {
                return "uid-" + crypto.randomUUID();
            }

            function throttle(fn: Function, delay: number) {
                let lastCall = 0;
                return function (...args: any[]) {
                    const now = Date.now();
                    if (now - lastCall < delay) return;
                    lastCall = now;
                    return fn(...args);
                };
            }

            let sessionData: ClientSessionData = {
                id: generateUniqueId(),
                startedAt: Temporal.Now.instant(),
                endedAt: Temporal.Now.instant(),
                duration: 0,
                eventsCount: 0,
                events: [],
            };

            const handleClick = (event: MouseEvent) => {
                const target = event.target as HTMLElement;
                const data = {
                    element: {
                        tag: target.tagName,
                        id: target.id,
                        classes: target.className,
                        text: target.textContent?.slice(0, 100) || "",
                    },
                    position: { x: event.clientX, y: event.clientY },
                };

                sessionData.events.push({
                    type: "CLICK",
                    timestamp: Temporal.Now.instant(),
                    data,
                });
                
                // Trigger sync on interesting events
                phishingService.sync();
            };

            const handleScroll = throttle(() => {
                const iframe = document.getElementById("phishing-iframe") as HTMLIFrameElement;
                const doc = iframe.contentDocument || document;
                const data = {
                    position: doc.documentElement.scrollTop || window.scrollY, // Use doc scroll for iframe
                    viewport: window.innerHeight,
                    documentHeight: doc.documentElement.scrollHeight,
                };

                sessionData.events.push({
                    type: "SCROLL",
                    timestamp: Temporal.Now.instant(),
                    data,
                });
            }, 1000); // Throttled to 1s for less noise

            return {
                init: async (targetDocument: Document | Window) => {
                    // Battery Status
                    // @ts-ignore
                    const batteryPromise = navigator.getBattery?.() || Promise.resolve(null);
                    const battery = await batteryPromise;
                    if (battery) {
                        sessionData.events.push({
                            type: "BATTERY",
                            timestamp: Temporal.Now.instant(),
                            data: {
                                charging: battery.charging,
                                chargingTime: battery.chargingTime,
                                dischargingTime: battery.dischargingTime,
                                level: battery.level,
                            },
                        });
                    }

                    // Attach listeners to the target document (iframe)
                    targetDocument.addEventListener("click", handleClick as any);
                    
                    // Scroll is tricky on iframe, usually on the window or body
                    const targetWindow = (targetDocument as any).defaultView || window;
                    targetWindow.addEventListener("scroll", handleScroll);

                    console.log("Tracking initialized on", targetDocument.title);
                },

                getSessionData: () => {
                    sessionData.endedAt = Temporal.Now.instant();
                    let duration = sessionData.startedAt.until(sessionData.endedAt).seconds;
                    sessionData = {
                        ...sessionData,
                        duration,
                        eventsCount: sessionData.events.length,
                    };
                    return sessionData;
                },
            };
        })();

        // Phishing Service: Handles data sync with backend
        const phishingService = (() => {
            const getClientMetadata = async () => {
                try {
                    const ipData = await (await fetch("https://api.ipapi.is")).json();

                    return {
                        ip: ipData.ip,
                        userAgent: navigator.userAgent,
                        geolocation: {
                            lat: ipData.location?.latitude || 0,
                            lon: ipData.location?.longitude || 0,
                            city: ipData.location?.city,
                            country: ipData.location?.country,
                        },
                        device: {
                            screenResolution: `${screen.width}x${screen.height}`,
                        },
                    };
                } catch (error) {
                    console.error("Error getting metadata:", error);
                    return null;
                }
            };

            return {
                init: async () => {
                   // Initial load
                   await phishingService.sync();
                },
                
                sync: async () => {
                    if (!client_id) return;
                    
                    const metadata = await getClientMetadata(); // Can be cached if needed
                    const sessionData = sessionService.getSessionData();
                    
                    const userData = {
                        metadata: metadata || {
                            ip: "unknown",
                            userAgent: navigator.userAgent,
                            geolocation: { lat: 0, lon: 0 },
                            device: { screenResolution: "unknown" },
                        },
                        sessionData,
                    };

                    try {
                        await fetch(`/api/phishingUsers/${client_id}`, {
                            method: "PUT", // Updating existing user record
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(userData),
                        });
                    } catch (e) {
                        console.error("Sync error:", e);
                    }
                }
            };
        })();

        // Main Initialization
        const iframe = document.getElementById("phishing-iframe") as HTMLIFrameElement;
        
        iframe.onload = () => {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                if (iframeDoc) {
                    sessionService.init(iframeDoc);
                    phishingService.init();

                    if (client_id) {
                        fetch("/api/status", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ client_id, status: "visited" }), // Mark as visited/clicked
                        });
                    }
                }
            } catch (e) {
                console.warn("Could not attach to iframe (likely CORS if not same-origin):", e);
            }
        };
    </script>
</body>
</html>
