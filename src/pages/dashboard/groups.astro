---
import Layout from "@/layouts/dashboard.astro";
import { app } from "@/firebase/server";
import { getFirestore } from "firebase-admin/firestore";
import type { PhishingUser } from "@/types";
import { Users, Tag } from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

const db = getFirestore(app);
const snapshot = await db.collection("phishingUsers").get();
const users = snapshot.docs.map((doc) => doc.data() as PhishingUser);

// Aggregate tags
const tagCounts: Record<string, number> = {};
let usersWithTags = 0;

users.forEach((user) => {
    if (user.tags && Array.isArray(user.tags)) {
        if (user.tags.length > 0) usersWithTags++;
        user.tags.forEach((tag) => {
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
        });
    }
});

const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
---

<Layout title="Gestión de Grupos">
    <main class="space-y-6">
        <header>
            <h3 class="text-lg font-medium">Grupos y Etiquetas</h3>
            <p class="text-sm text-muted-foreground">
                Visualiza y administra los grupos de usuarios basados en
                etiquetas.
            </p>
        </header>

        <div class="grid gap-4 md:grid-cols-3">
            <Card>
                <CardHeader
                    className="flex flex-row items-center justify-between space-y-0 pb-2"
                >
                    <CardTitle className="text-sm font-medium">
                        Total Etiquetas
                    </CardTitle>
                    <Tag className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                    <div class="text-2xl font-bold">
                        {Object.keys(tagCounts).length}
                    </div>
                </CardContent>
            </Card>
            <Card>
                <CardHeader
                    className="flex flex-row items-center justify-between space-y-0 pb-2"
                >
                    <CardTitle className="text-sm font-medium">
                        Usuarios Etiquetados
                    </CardTitle>
                    <Users className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                    <div class="text-2xl font-bold">{usersWithTags}</div>
                </CardContent>
            </Card>
            <Card>
                <CardHeader
                    className="flex flex-row items-center justify-between space-y-0 pb-2"
                >
                    <CardTitle className="text-sm font-medium">
                        Total Usuarios
                    </CardTitle>
                    <Users className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                    <div class="text-2xl font-bold">{users.length}</div>
                </CardContent>
            </Card>
        </div>

        <section class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {
                sortedTags.map(([tag, count]) => (
                    <Card key={tag}>
                        <CardHeader className="pb-2">
                            <CardTitle className="text-base font-medium flex items-center gap-2">
                                <Tag className="h-4 w-4" />
                                {tag}
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div class="text-2xl font-bold">{count}</div>
                            <p class="text-xs text-muted-foreground">
                                usuarios en este grupo
                            </p>
                        </CardContent>
                    </Card>
                ))
            }
            {
                sortedTags.length === 0 && (
                    <div class="col-span-full text-center py-12 text-muted-foreground border rounded-lg border-dashed">
                        No hay etiquetas creadas. Ve a "Campañas" para asignar
                        etiquetas a los usuarios.
                    </div>
                )
            }
        </section>
    </main>
</Layout>
